<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Индикатор Батареи Home Assistant</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; background-color: #f4f4f9; }
        h1 { margin-bottom: 30px; color: #333; }
        .battery-grid { display: flex; gap: 40px; }
        
        .indicator-unit { display: flex; flex-direction: column; align-items: center; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .battery-container { width: 150px; height: 100px; border: 4px solid #333; border-radius: 15px; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-top: 10px; background-color: #f8f8f8; }
        .battery-container::after { content: ''; position: absolute; right: -15px; top: 50%; transform: translateY(-50%); width: 10px; height: 25px; background-color: #333; border-radius: 0 5px 5px 0; }
        .battery-level { font-size: 2.5em; font-weight: bold; color: #333; }
        .status-text { margin-top: 5px; font-size: 0.9em; color: #666; }
        .timestamp-text { margin-top: 10px; font-size: 0.8em; color: #999; text-align: center; }

        .charging { animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <h1>Индикаторы Батарей Home Assistant</h1>
    <div class="battery-grid" id="battery-grid">
        </div>

    <script>
        const NUM_BATTERIES = 3;
        const grid = document.getElementById('battery-grid');

        // Создание HTML-элементов для каждой батареи
        for (let i = 1; i <= NUM_BATTERIES; i++) {
            const unit = document.createElement('div');
            unit.className = 'indicator-unit';
            unit.innerHTML = `
                <h2>Батарея ${i}</h2>
                <div class="battery-container" id="container-${i}">
                    <div class="battery-level" id="level-${i}">--%</div>
                </div>
                <div class="status-text" id="status-${i}">Ожидание данных...</div>
                <div class="timestamp-text" id="time-${i}">Последнее обновление: Н/Д</div>
            `;
            grid.appendChild(unit);
        }

        // Вспомогательная функция для форматирования времени
        function formatTimestamp(isoString) {
            if (!isoString) return 'Н/Д';
            // Преобразуем UTC строку в локальное время
            const date = new Date(isoString);
            return date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU');
        }

        // Функция для обновления интерфейса
        async function updateBatteryStatus() {
            try {
                // Запрос к функции Cloudflare Pages
                const response = await fetch('/api/data');
                const batteries = await response.json(); // Ожидаем массив [{id, level, isCharging, timestamp}, ...]

                batteries.forEach(data => {
                    const { id, level, isCharging, timestamp } = data;

                    const levelEl = document.getElementById(`level-${id}`);
                    const statusEl = document.getElementById(`status-${id}`);
                    const containerEl = document.getElementById(`container-${id}`);
                    const timeEl = document.getElementById(`time-${id}`);

                    if (levelEl) {
                        levelEl.textContent = `${level}%`;
                        statusEl.textContent = isCharging ? 'Заряжается ⚡' : 'Не заряжается';
                        timeEl.textContent = `Обновлено: ${formatTimestamp(timestamp)}`;

                        // Цветовая индикация
                        if (level <= 20) {
                            levelEl.style.color = '#d9534f'; // Красный
                        } else if (level <= 50) {
                            levelEl.style.color = '#f0ad4e'; // Оранжевый
                        } else {
                            levelEl.style.color = '#5cb85c'; // Зеленый
                        }
                        
                        containerEl.classList.toggle('charging', isCharging);
                    }
                });

            } catch (error) {
                console.error('Ошибка при получении данных:', error);
                // Обновление всех статусов в случае ошибки
                for (let i = 1; i <= NUM_BATTERIES; i++) {
                    document.getElementById(`level-${i}`).textContent = 'Ош.';
                    document.getElementById(`status-${i}`).textContent = 'Ошибка сети';
                    document.getElementById(`time-${i}`).textContent = 'Обновлено: Ошибка';
                }
            }
        }

        // Обновлять данные каждые 5 секунд
        updateBatteryStatus(); 
        setInterval(updateBatteryStatus, 5000); 
    </script>
</body>
</html>
